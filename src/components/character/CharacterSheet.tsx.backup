import { useState } from 'react';
import type { Character } from '@/types/character';
import { computeEntityStats } from '@/lib/computation-engine';
import { getArchetypeById } from '@/data/archetypes';
import { getSpeciesById } from '@/data/species';
import { getAbilityById } from '@/data/abilities';
import { performTest } from '@/lib/dice-engine';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Separator } from '@/components/ui/separator';
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { ScrollArea } from '@/components/ui/scroll-area';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
import { ATTRIBUTES, SKILLS, SKILL_NAMES, SKILL_ATTRIBUTES } from '@/types/entity';
import type { SkillName } from '@/types/entity';
import { ArrowUp } from 'lucide-react';

interface RollResult {
  id: string;
  timestamp: Date;
  skillName: string;
  linkedAttr: string;
  dicePool: number;
  dn: number;
  result: any;
}

interface CharacterSheetProps {
  character: Character;
  onCharacterUpdate: (character: Character) => void;
}

export function CharacterSheet({ character }: CharacterSheetProps) {
  const [rollHistory, setRollHistory] = useState<RollResult[]>([]);
  const [rollDialogOpen, setRollDialogOpen] = useState(false);
  const [selectedSkill, setSelectedSkill] = useState<SkillName | null>(null);
  const [dn, setDn] = useState(3);
  const [ed, setEd] = useState(0);

  const stats = computeEntityStats(character);
  const archetype = character.archetype ? getArchetypeById(character.archetype) : null;
  const ability = archetype?.ability.abilityId ? getAbilityById(archetype.ability.abilityId) : null;

  // Handle skill click - open modal
  const handleSkillClick = (skill: SkillName) => {
    setSelectedSkill(skill);
    setRollDialogOpen(true);
  };

  // Handle actual roll
  const handleRoll = () => {
    if (!selectedSkill) return;
    
    const linkedAttr = SKILL_ATTRIBUTES[selectedSkill];
    const attributeValue = stats[linkedAttr];
    const skillValue = stats.skills[selectedSkill];
    const baseDicePool = attributeValue + skillValue;
    const totalPool = baseDicePool + ed;
    
    const testResult = performTest(totalPool, dn, 1);
    
    const newRoll: RollResult = {
      id: Date.now().toString(),
      timestamp: new Date(),
      skillName: SKILL_NAMES[selectedSkill],
      linkedAttr,
      dicePool: totalPool,
      dn,
      result: testResult,
    };
    
    setRollHistory([newRoll, ...rollHistory]);
    setRollDialogOpen(false);
    setEd(0); // Reset ED after roll
  };

  const clearHistory = () => {
    setRollHistory([]);
  };

  // Get attribute breakdown (for tooltips)
  const getAttributeBreakdown = (attr: string) => {
    const prop = Object.values(character.properties).find(p => p.id === `attr-${attr}`);
    const baseValue = prop && 'value' in prop ? (prop.value as number) : 1;
    const bonuses = 0; // TODO: Calculate from equipment/effects
    const penalties = 0; // TODO: Calculate from effects
    
    return {
      base: baseValue,
      bonuses,
      penalties,
      total: baseValue + bonuses - penalties
    };
  };

  // Get skill breakdown (for tooltips)
  const getSkillBreakdown = (skill: SkillName) => {
    const prop = Object.values(character.properties).find(p => p.id === `skill-${skill}`);
    const purchased = prop && 'value' in prop ? (prop.value as number) : 0;
    const bonuses = 0; // TODO: Calculate from abilities/equipment
    const penalties = 0; // TODO: Calculate from effects
    
    return {
      purchased,
      bonuses,
      penalties,
      total: purchased + bonuses - penalties
    };
  };

  // Calculate rank from tier (Tier 1-2 = Rank 1, Tier 3-4 = Rank 2, Tier 5 = Rank 3)
  const calculateRank = () => {
    if (character.tier <= 2) return 1;
    if (character.tier <= 4) return 2;
    return 3;
  };

  const species = getSpeciesById(character.species);

  return (
    <TooltipProvider>
      <div className="w-full max-w-[1920px] mx-auto px-4 sm:px-6 lg:px-8 py-6">
        {/* Character Header - D&D Beyond Style */}
        <Card className="mb-4 border-2">
          <CardHeader className="pb-4">
            <div className="flex items-start gap-6">
              {/* Character Portrait */}
              <div className="shrink-0">
                <div className="w-20 h-20 rounded-lg border-2 bg-gradient-to-br from-muted/50 to-muted/30 flex items-center justify-center text-3xl shadow-sm">
                  ‚öîÔ∏è
                </div>
              </div>

              {/* Character Info */}
              <div className="flex-1 min-w-0">
                <h1 className="text-2xl font-bold tracking-tight truncate mb-1">{character.name}</h1>
                <div className="flex items-center gap-2 text-sm text-muted-foreground mb-2">
                  <span className="font-medium">{archetype?.name}</span>
                  <span>‚Ä¢</span>
                  <span className="font-medium">{species?.name || character.species}</span>
                </div>
                <div className="flex items-center gap-3 text-sm text-muted-foreground mb-2">
                  <span>Tier {character.tier}</span>
                  <span>‚Ä¢</span>
                  <span>Rank {calculateRank()}</span>
                  <span>‚Ä¢</span>
                  <span className="font-medium text-primary">{character.xpAvailable} XP</span>
                </div>
                <div className="flex flex-wrap gap-1.5">
                  {character.keywords.map((kw) => (
                    <Badge key={kw} variant="secondary" className="text-xs font-medium px-2 py-0.5">{kw}</Badge>
                  ))}
                </div>
              </div>

              {/* XP Display */}
              <div className="shrink-0 text-right border-l-2 pl-6">
                <div className="text-3xl font-bold text-primary tabular-nums">{character.xpAvailable}</div>
                <div className="text-xs text-muted-foreground uppercase font-medium tracking-wide">XP Available</div>
                <div className="text-xs text-muted-foreground mt-1">{character.xpSpent} Spent ‚Ä¢ {character.xpTotal} Total</div>
              </div>
            </div>
          </CardHeader>
        </Card>

        {/* 4 Column Layout: Attributes | Traits | Skills | Tabs | Dice Log */}
        <div className="grid grid-cols-1 lg:grid-cols-[minmax(200px,280px)_minmax(200px,280px)_minmax(200px,280px)_1fr_350px] gap-4">
          {/* Column 1: Attributes */}
          <Card className="h-fit">
            <CardHeader className="pb-3 border-b">
              <CardTitle className="text-base font-bold">Attributes</CardTitle>
            </CardHeader>
            <CardContent className="pt-3">
              <div className="space-y-1">
                {ATTRIBUTES.map((attr) => {
                  const breakdown = getAttributeBreakdown(attr);
                  const value = stats[attr];
                  
                  return (
                    <div key={attr} className="flex justify-between items-center py-2 px-3 rounded hover:bg-muted/50 transition-colors">
                      <Tooltip>
                        <TooltipTrigger asChild>
                          <span className="text-sm font-medium capitalize cursor-help underline decoration-dotted decoration-muted-foreground/30">{attr}</span>
                        </TooltipTrigger>
                        <TooltipContent side="right">
                          <div className="space-y-1 text-xs">
                            <div className="font-semibold capitalize">{attr}</div>
                            <Separator className="my-1" />
                            <div className="flex justify-between gap-4">
                              <span className="text-muted-foreground">Base:</span>
                              <span className="font-mono">{breakdown.base}</span>
                            </div>
                            {breakdown.bonuses > 0 && (
                              <div className="flex justify-between gap-4 text-green-600">
                                <span>Bonuses:</span>
                                <span className="font-mono">+{breakdown.bonuses}</span>
                              </div>
                            )}
                            {breakdown.penalties > 0 && (
                              <div className="flex justify-between gap-4 text-red-600">
                                <span>Penalties:</span>
                                <span className="font-mono">-{breakdown.penalties}</span>
                              </div>
                            )}
                            <Separator className="my-1" />
                            <div className="flex justify-between gap-4 font-bold">
                              <span>Total:</span>
                              <span className="font-mono">{breakdown.total}</span>
                            </div>
                          </div>
                        </TooltipContent>
                      </Tooltip>
                      <span className="text-base font-bold tabular-nums">{value}</span>
                    </div>
                  );
                })}
              </div>
            </CardContent>
          </Card>

          {/* Column 2: Traits (Derived Stats) */}
          <Card className="h-fit">
            <CardHeader className="pb-3 border-b">
              <CardTitle className="text-base font-bold">Traits</CardTitle>
            </CardHeader>
            <CardContent className="pt-3">
              <div className="space-y-1">
                <div className="flex justify-between items-center py-2 px-3 rounded hover:bg-muted/50 transition-colors">
                  <Tooltip>
                    <TooltipTrigger asChild>
                      <span className="text-sm cursor-help underline decoration-dotted decoration-muted-foreground/30">Defence</span>
                    </TooltipTrigger>
                    <TooltipContent side="right">
                      <div className="text-xs">Initiative - 1</div>
                    </TooltipContent>
                  </Tooltip>
                  <span className="text-base font-bold tabular-nums">{stats.defence}</span>
                </div>

                <div className="flex justify-between items-center py-2 px-3 rounded hover:bg-muted/50 transition-colors">
                  <Tooltip>
                    <TooltipTrigger asChild>
                      <span className="text-sm cursor-help underline decoration-dotted decoration-muted-foreground/30">Resilience</span>
                    </TooltipTrigger>
                    <TooltipContent side="right">
                      <div className="text-xs">Toughness + 1</div>
                    </TooltipContent>
                  </Tooltip>
                  <span className="text-base font-bold tabular-nums">{stats.resilience}</span>
                </div>

                <div className="flex justify-between items-center py-2 px-3 rounded hover:bg-muted/50 transition-colors">
                  <Tooltip>
                    <TooltipTrigger asChild>
                      <span className="text-sm cursor-help underline decoration-dotted decoration-muted-foreground/30">Determination</span>
                    </TooltipTrigger>
                    <TooltipContent side="right">
                      <div className="text-xs">= Toughness</div>
                    </TooltipContent>
                  </Tooltip>
                  <span className="text-base font-bold tabular-nums">{stats.determination}</span>
                </div>

                <div className="flex justify-between items-center py-2 px-3 rounded hover:bg-muted/50 transition-colors">
                  <Tooltip>
                    <TooltipTrigger asChild>
                      <span className="text-sm cursor-help underline decoration-dotted decoration-muted-foreground/30">Max Wounds</span>
                    </TooltipTrigger>
                    <TooltipContent side="right">
                      <div className="text-xs">(2 √ó Tier) + Toughness</div>
                    </TooltipContent>
                  </Tooltip>
                  <span className="text-base font-bold tabular-nums">{stats.maxWounds}</span>
                </div>

                <div className="flex justify-between items-center py-2 px-3 rounded hover:bg-muted/50 transition-colors">
                  <Tooltip>
                    <TooltipTrigger asChild>
                      <span className="text-sm cursor-help underline decoration-dotted decoration-muted-foreground/30">Max Shock</span>
                    </TooltipTrigger>
                    <TooltipContent side="right">
                      <div className="text-xs">Willpower + Tier</div>
                    </TooltipContent>
                  </Tooltip>
                  <span className="text-base font-bold tabular-nums">{stats.maxShock}</span>
                </div>

                <div className="flex justify-between items-center py-2 px-3 rounded hover:bg-muted/50 transition-colors">
                  <Tooltip>
                    <TooltipTrigger asChild>
                      <span className="text-sm cursor-help underline decoration-dotted decoration-muted-foreground/30">Speed</span>
                    </TooltipTrigger>
                    <TooltipContent side="right">
                      <div className="text-xs">Movement per turn</div>
                    </TooltipContent>
                  </Tooltip>
                  <span className="text-base font-bold tabular-nums">{stats.speed}</span>
                </div>

                <div className="flex justify-between items-center py-2 px-3 rounded hover:bg-muted/50 transition-colors">
                  <Tooltip>
                    <TooltipTrigger asChild>
                      <span className="text-sm cursor-help underline decoration-dotted decoration-muted-foreground/30">Conviction</span>
                    </TooltipTrigger>
                    <TooltipContent side="right">
                      <div className="text-xs">For re-rolls</div>
                    </TooltipContent>
                  </Tooltip>
                  <span className="text-base font-bold tabular-nums">{stats.conviction}</span>
                </div>

                <div className="flex justify-between items-center py-2 px-3 rounded hover:bg-muted/50 transition-colors">
                  <Tooltip>
                    <TooltipTrigger asChild>
                      <span className="text-sm cursor-help underline decoration-dotted decoration-muted-foreground/30">Resolve</span>
                    </TooltipTrigger>
                    <TooltipContent side="right">
                      <div className="text-xs">Passive Willpower</div>
                    </TooltipContent>
                  </Tooltip>
                  <span className="text-base font-bold tabular-nums">{stats.resolve}</span>
                </div>

                <div className="flex justify-between items-center py-2 px-3 rounded hover:bg-muted/50 transition-colors">
                  <Tooltip>
                    <TooltipTrigger asChild>
                      <span className="text-sm cursor-help underline decoration-dotted decoration-muted-foreground/30">Influence</span>
                    </TooltipTrigger>
                    <TooltipContent side="right">
                      <div className="text-xs">Social standing</div>
                    </TooltipContent>
                  </Tooltip>
                  <span className="text-base font-bold tabular-nums">{stats.influence}</span>
                </div>

                <div className="flex justify-between items-center py-2 px-3 rounded hover:bg-muted/50 transition-colors">
                  <Tooltip>
                    <TooltipTrigger asChild>
                      <span className="text-sm cursor-help underline decoration-dotted decoration-muted-foreground/30">Wealth</span>
                    </TooltipTrigger>
                    <TooltipContent side="right">
                      <div className="text-xs">Available resources</div>
                    </TooltipContent>
                  </Tooltip>
                  <span className="text-base font-bold tabular-nums">{stats.wealth}</span>
                </div>

                <div className="flex justify-between items-center py-2 px-3 rounded hover:bg-muted/50 transition-colors">
                  <Tooltip>
                    <TooltipTrigger asChild>
                      <span className="text-sm cursor-help underline decoration-dotted decoration-muted-foreground/30">Passive Awareness</span>
                    </TooltipTrigger>
                    <TooltipContent side="right">
                      <div className="text-xs">= Awareness skill</div>
                    </TooltipContent>
                  </Tooltip>
                  <span className="text-base font-bold tabular-nums">{stats.passiveAwareness}</span>
                </div>
              </div>
            </CardContent>
          </Card>

          {/* Column 3: Skills */}
          <Card className="h-fit">
            <CardHeader className="pb-3 border-b">
              <CardTitle className="text-base font-bold">Skills</CardTitle>
            </CardHeader>
            <CardContent className="pt-3">
              <ScrollArea className="h-[600px] pr-3">
                <div className="space-y-1">
                  {SKILLS.map((skill) => {
                    const breakdown = getSkillBreakdown(skill);
                    const value = stats.skills[skill] || 0;
                    const linkedAttr = SKILL_ATTRIBUTES[skill];
                    
                    return (
                      <div
                        key={skill}
                        className="flex justify-between items-center py-2 px-3 rounded hover:bg-accent/50 transition-colors cursor-pointer"
                        onClick={() => handleRollSkill(skill)}
                      >
                        <Tooltip>
                          <TooltipTrigger asChild>
                            <span className="text-sm cursor-help underline decoration-dotted decoration-muted-foreground/30">
                              {SKILL_NAMES[skill]}
                            </span>
                          </TooltipTrigger>
                          <TooltipContent side="right">
                            <div className="space-y-1 text-xs">
                              <div className="font-semibold">{SKILL_NAMES[skill]}</div>
                              <Separator className="my-1" />
                              <div className="flex justify-between gap-4">
                                <span className="text-muted-foreground">Linked Attribute:</span>
                                <span className="font-mono capitalize">{linkedAttr}</span>
                              </div>
                              <div className="flex justify-between gap-4">
                                <span className="text-muted-foreground">Purchased Ranks:</span>
                                <span className="font-mono">{breakdown.purchased}</span>
                              </div>
                              {breakdown.bonuses > 0 && (
                                <div className="flex justify-between gap-4 text-green-600">
                                  <span>Bonuses:</span>
                                  <span className="font-mono">+{breakdown.bonuses}</span>
                                </div>
                              )}
                              {breakdown.penalties > 0 && (
                                <div className="flex justify-between gap-4 text-red-600">
                                  <span>Penalties:</span>
                                  <span className="font-mono">-{breakdown.penalties}</span>
                                </div>
                              )}
                              <Separator className="my-1" />
                              <div className="flex justify-between gap-4 font-bold">
                                <span>Total:</span>
                                <span className="font-mono">{breakdown.total}</span>
                              </div>
                              <div className="text-xs text-muted-foreground mt-2">Click to roll</div>
                            </div>
                          </TooltipContent>
                        </Tooltip>
                        <span className="text-base font-bold tabular-nums">{value}</span>
                      </div>
                    );
                  })}
                </div>
              </ScrollArea>
            </CardContent>
          </Card>
                    const totalDicePool = attributeValue + skillRanks;
                    const breakdown = getSkillBreakdown(skill);

                    return (
                      <Tooltip key={skill}>
                        <TooltipTrigger asChild>
                          <div
                            className="flex justify-between items-center py-1.5 px-2 rounded hover:bg-primary/10 cursor-pointer transition-colors border border-transparent hover:border-primary/30"
                            onClick={() => handleSkillClick(skill)}
                          >
                            <span className="text-sm font-medium cursor-help">
                              {SKILL_NAMES[skill]}
                            </span>
                            <span className="text-sm font-bold tabular-nums">{totalDicePool}</span>
                          </div>
                        </TooltipTrigger>
                        <TooltipContent>
                          <div className="space-y-0.5 text-xs">
                            <div className="font-semibold">{SKILL_NAMES[skill]}</div>
                            <Separator className="my-1" />
                            <div className="flex justify-between gap-4">
                              <span className="text-muted-foreground">Linked ({linkedAttr.slice(0, 3).toUpperCase()}):</span>
                              <span className="font-mono">{attributeValue}</span>
                            </div>
                            <div className="flex justify-between gap-4">
                              <span className="text-muted-foreground">Purchased Ranks:</span>
                              <span className="font-mono">{breakdown.purchased}</span>
                            </div>
                            {breakdown.bonuses > 0 && (
                              <div className="flex justify-between gap-4 text-green-600">
                                <span>Bonuses:</span>
                                <span className="font-mono">+{breakdown.bonuses}</span>
                              </div>
                            )}
                            {breakdown.penalties > 0 && (
                              <div className="flex justify-between gap-4 text-red-600">
                                <span>Penalties:</span>
                                <span className="font-mono">-{breakdown.penalties}</span>
                              </div>
                            )}
                            <Separator className="my-1" />
                            <div className="flex justify-between gap-4 font-semibold">
                              <span>Total Dice Pool:</span>
                              <span className="font-mono">{totalDicePool}</span>
                            </div>
                          </div>
                        </TooltipContent>
                      </Tooltip>
                    );
                  })}
                </div>
              </CardContent>
            </Card>
          </div>

          {/* Middle Column: Tabbed Content */}
          <div>
            <Card className="h-full">
              <Tabs defaultValue="abilities" className="h-full flex flex-col">
                <CardHeader className="pb-2 border-b shrink-0">
                  <TabsList className="w-full justify-start grid grid-cols-4">
                    <TabsTrigger value="weapons" className="text-xs">Weapons</TabsTrigger>
                    <TabsTrigger value="wargear" className="text-xs">Wargear</TabsTrigger>
                    <TabsTrigger value="abilities" className="text-xs">Abilities</TabsTrigger>
                    <TabsTrigger value="description" className="text-xs">Description</TabsTrigger>
                  </TabsList>
                </CardHeader>
                
                <CardContent className="pt-4 flex-1 overflow-auto">
                  <TabsContent value="weapons" className="mt-0">
                    <div className="text-sm text-muted-foreground py-8 text-center">
                      No weapons equipped yet
                    </div>
                  </TabsContent>

                  <TabsContent value="wargear" className="mt-0">
                    {archetype && archetype.wargear && archetype.wargear.length > 0 ? (
                      <div className="space-y-2">
                        {archetype.wargear.map((item, idx) => {
                          if (typeof item === 'string') {
                            return (
                              <div key={idx} className="flex items-center gap-2 py-2 px-3 border rounded text-sm">
                                <span>‚öîÔ∏è</span>
                                <span className="font-medium">{item}</span>
                              </div>
                            );
                          }
                          return (
                            <div key={idx} className="flex items-center gap-2 py-2 px-3 border rounded text-sm">
                              <span>üì¶</span>
                              <div className="flex-1">
                                <div className="font-medium">
                                  {item.type === 'specific' && item.items ? item.items.join(', ') : 'Wargear option'}
                                </div>
                                <div className="text-xs text-muted-foreground mt-0.5">
                                  <Badge variant="outline" className="text-xs mr-1">{item.type}</Badge>
                                  {item.type === 'choice' && item.items && `Choose ${item.count || 1}`}
                                  {item.type === 'any' && 'Any wargear'}
                                </div>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    ) : (
                      <div className="text-sm text-muted-foreground py-8 text-center">
                        No wargear
                      </div>
                    )}
                  </TabsContent>

                  <TabsContent value="abilities" className="mt-0">
                    {archetype && ability ? (
                      <div className="space-y-4">
                        <div className="border-l-2 border-primary pl-4">
                          <div className="flex items-start gap-2 mb-2">
                            <Badge variant="outline" className="text-xs">
                              Archetype
                            </Badge>
                            <Badge variant="secondary" className="text-xs">
                              {ability.activation}
                            </Badge>
                          </div>
                          
                          <div className="mb-3">
                            <h3 className="text-base font-bold inline">{archetype.ability.name}</h3>
                            <span className="text-muted-foreground text-sm"> ‚Ä¢ </span>
                            <span className="text-sm text-muted-foreground italic">{archetype.name}</span>
                          </div>
                          
                          <p className="text-sm leading-relaxed">
                            {archetype.ability.description.split(/\b/).map((word, idx) => {
                              // Check if word is a keyword (all caps, at least 2 letters)
                              const trimmedWord = word.trim();
                              if (trimmedWord.length >= 2 && /^[A-Z]+$/.test(trimmedWord)) {
                                return (
                                  <Tooltip key={idx}>
                                    <TooltipTrigger asChild>
                                      <span className="font-semibold text-primary cursor-help hover:underline">
                                        {word}
                                      </span>
                                    </TooltipTrigger>
                                    <TooltipContent>
                                      <div className="text-xs">
                                        <div className="font-semibold mb-1">{trimmedWord} Keyword</div>
                                        <div className="text-muted-foreground">
                                          Character or faction keyword
                                        </div>
                                      </div>
                                    </TooltipContent>
                                  </Tooltip>
                                );
                              }
                              return <span key={idx}>{word}</span>;
                            })}
                          </p>

                          {ability.effects && ability.effects.length > 0 && (
                            <div className="mt-3 space-y-1.5">
                              {ability.effects.map((effect, idx) => {
                                if (effect.type === 'bonus-dice') {
                                  return (
                                    <div key={idx} className="flex items-center gap-1.5 text-xs text-green-700">
                                      <ArrowUp className="h-3 w-3" />
                                      <span className="font-medium">+{effect.bonusDice} bonus dice</span>
                                    </div>
                                  );
                                }
                                if (effect.type === 'heal') {
                                  return (
                                    <div key={idx} className="flex items-center gap-1.5 text-xs text-blue-700">
                                      <ArrowUp className="h-3 w-3" />
                                      <span className="font-medium">Heal {effect.healAmount} {effect.healType}</span>
                                    </div>
                                  );
                                }
                                if (effect.type === 'special') {
                                  return (
                                    <div key={idx} className="text-xs text-purple-700">
                                      <span className="font-medium">{effect.specialText}</span>
                                    </div>
                                  );
                                }
                                return null;
                              })}
                            </div>
                          )}
                        </div>
                      </div>
                    ) : (
                      <div className="text-sm text-muted-foreground py-8 text-center">
                        No abilities
                      </div>
                    )}
                  </TabsContent>

                  <TabsContent value="description" className="mt-0">
                    <div className="text-sm space-y-2">
                      {archetype?.description ? (
                        <p>{archetype.description}</p>
                      ) : (
                        <p className="text-muted-foreground text-center py-8">No description available</p>
                      )}
                    </div>
                  </TabsContent>
                </CardContent>
              </Tabs>
            </Card>
          </div>

          {/* Right Column: Dice Log */}
          <div>
            <Card className="h-[calc(100vh-200px)] flex flex-col">
              <CardHeader className="pb-2 border-b shrink-0">
                <div className="flex items-center justify-between">
                  <CardTitle className="text-sm">Dice Log</CardTitle>
                  {rollHistory.length > 0 && (
                    <Button variant="ghost" size="sm" onClick={clearHistory} className="h-7 text-xs">
                      Clear
                    </Button>
                  )}
                </div>
              </CardHeader>
              
              <CardContent className="p-0 flex-1 overflow-hidden">
                <ScrollArea className="h-full">
                  <div className="p-3 space-y-2">
                    {rollHistory.length === 0 ? (
                      <div className="text-center text-muted-foreground py-12">
                        <p className="text-sm">Click any skill to roll</p>
                        <p className="text-xs mt-1">Rolls appear here</p>
                      </div>
                    ) : (
                      rollHistory.map((roll) => (
                        <div
                          key={roll.id}
                          className="border rounded-lg p-2.5 bg-card hover:bg-muted/50 transition-colors"
                        >
                          {/* Roll Header */}
                          <div className="flex items-start justify-between mb-1.5">
                            <div>
                              <div className="font-semibold text-xs">{roll.skillName}</div>
                              <div className="text-xs text-muted-foreground">
                                {roll.linkedAttr.slice(0, 3).toUpperCase()} ‚Ä¢ {roll.dicePool}d vs DN{roll.dn}
                              </div>
                            </div>
                            <div className="text-xs text-muted-foreground">
                              {roll.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                            </div>
                          </div>

                          {/* Result Badge */}
                          <div className="mb-1.5">
                            {roll.result.success ? (
                              <div className="inline-flex items-center gap-1 px-1.5 py-0.5 bg-green-500/10 border border-green-500/20 rounded text-xs text-green-700 font-medium">
                                ‚úì {roll.result.icons} icons
                              </div>
                            ) : (
                              <div className="inline-flex items-center gap-1 px-1.5 py-0.5 bg-red-500/10 border border-red-500/20 rounded text-xs text-red-700 font-medium">
                                ‚úó {roll.result.icons} icons
                              </div>
                            )}
                          </div>

                          {/* Dice Visual */}
                          <div className="flex flex-wrap gap-1">
                            {roll.result.rolls?.slice(0, -1).map((dieRoll: number, idx: number) => (
                              <div
                                key={idx}
                                className={`w-7 h-7 flex items-center justify-center rounded border text-xs font-bold ${
                                  dieRoll === 6
                                    ? 'bg-yellow-100 border-yellow-400 text-yellow-900'
                                    : dieRoll >= roll.dn
                                    ? 'bg-green-100 border-green-400 text-green-900'
                                    : 'bg-muted border-border text-muted-foreground'
                                }`}
                              >
                                {dieRoll}
                              </div>
                            ))}
                            {roll.result.rolls && roll.result.rolls.length > 0 && (() => {
                              const wrathRoll = roll.result.rolls[roll.result.rolls.length - 1];
                              return (
                                <div
                                  className={`w-7 h-7 flex items-center justify-center rounded border text-xs font-bold ${
                                    wrathRoll === 6
                                      ? 'bg-purple-100 border-purple-400 text-purple-900'
                                      : wrathRoll === 1
                                      ? 'bg-red-100 border-red-400 text-red-900'
                                      : wrathRoll >= roll.dn
                                      ? 'bg-green-100 border-green-400 text-green-900'
                                      : 'bg-muted border-border text-muted-foreground'
                                  }`}
                                >
                                  {wrathRoll === 6 ? '‚ö°' : wrathRoll === 1 ? '‚ò†' : wrathRoll}
                                </div>
                              );
                            })()}
                          </div>

                          {/* Special Results */}
                          {(roll.result.glory || roll.result.complication || roll.result.shift > 0) && (
                            <div className="flex flex-wrap gap-1 mt-1.5">
                              {roll.result.glory && (
                                <div className="text-xs px-1.5 py-0.5 bg-purple-500/10 border border-purple-500/20 rounded text-purple-700 font-medium">
                                  ‚ö° Glory
                                </div>
                              )}
                              {roll.result.complication && (
                                <div className="text-xs px-1.5 py-0.5 bg-red-500/10 border border-red-500/20 rounded text-red-700 font-medium">
                                  ‚ò† Complication
                                </div>
                              )}
                              {roll.result.shift > 0 && (
                                <div className="text-xs px-1.5 py-0.5 bg-green-500/10 border border-green-500/20 rounded text-green-700 font-medium">
                                  +{roll.result.shift} Shift
                                </div>
                              )}
                            </div>
                          )}
                        </div>
                      ))
                    )}
                  </div>
                </ScrollArea>
              </CardContent>
            </Card>
          </div>
        </div>

        {/* Roll Configuration Dialog */}
        <Dialog open={rollDialogOpen} onOpenChange={setRollDialogOpen}>
          <DialogContent>
            <DialogHeader>
              <DialogTitle>Configure Roll</DialogTitle>
              <DialogDescription>
                {selectedSkill && `Rolling ${SKILL_NAMES[selectedSkill]}`}
              </DialogDescription>
            </DialogHeader>

            <div className="space-y-4 py-4">
              {/* Dice Pool Display */}
              {selectedSkill && (() => {
                const linkedAttr = SKILL_ATTRIBUTES[selectedSkill];
                const attributeValue = stats[linkedAttr];
                const skillValue = stats.skills[selectedSkill];
                const baseDicePool = attributeValue + skillValue;
                const totalPool = baseDicePool + ed;
                
                return (
                  <>
                    <div>
                      <div className="text-sm font-medium mb-2">Dice Pool</div>
                      <div className="text-4xl font-bold text-primary text-center py-4">
                        {totalPool}
                      </div>
                      <div className="text-xs text-center text-muted-foreground">
                        Base: {baseDicePool} ({linkedAttr} {attributeValue} + {SKILL_NAMES[selectedSkill]} {skillValue})
                        {ed > 0 && ` + ${ed} ED`}
                      </div>
                    </div>

                    <Separator />

                    {/* DN Input */}
                    <div>
                      <label htmlFor="dn-input" className="text-sm font-medium block mb-2">
                        Difficulty Number (DN)
                      </label>
                      <Input
                        id="dn-input"
                        type="number"
                        min="1"
                        max="10"
                        value={dn}
                        onChange={(e) => setDn(Math.max(1, Math.min(10, parseInt(e.target.value) || 3)))}
                        className="text-center text-lg font-bold"
                      />
                    </div>

                    {/* ED Input */}
                    <div>
                      <label htmlFor="ed-input" className="text-sm font-medium block mb-2">
                        Extra Dice (ED)
                      </label>
                      <div className="flex items-center gap-2">
                        <Button
                          variant="outline"
                          onClick={() => setEd(Math.max(0, ed - 1))}
                          className="flex-1"
                        >
                          -
                        </Button>
                        <Input
                          id="ed-input"
                          type="number"
                          min="0"
                          value={ed}
                          onChange={(e) => setEd(Math.max(0, parseInt(e.target.value) || 0))}
                          className="text-center text-lg font-bold w-24"
                        />
                        <Button
                          variant="outline"
                          onClick={() => setEd(ed + 1)}
                          className="flex-1"
                        >
                          +
                        </Button>
                      </div>
                    </div>
                  </>
                );
              })()}
            </div>

            <DialogFooter>
              <Button variant="outline" onClick={() => setRollDialogOpen(false)}>
                Cancel
              </Button>
              <Button onClick={handleRoll}>
                Roll Dice
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      </div>
    </TooltipProvider>
  );
}
